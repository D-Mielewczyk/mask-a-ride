name: Discord notify on PR opened to main

on:
  pull_request:
    branches: [main]
    types: [opened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

          # Podmien na swoje emoji z Discorda (mozna zostawic zwykle emoji)
          EMOJI_ALERT: ":point_right:"
          EMOJI_PR: "ðŸ”€"
          EMOJI_BRANCH: "ðŸŒ¿"
          EMOJI_AUTHOR: "ðŸ§‘â€ðŸ’»"
          EMOJI_LINK: "ðŸ”—"

          REPO: ${{ github.repository }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
          DRAFT: ${{ github.event.pull_request.draft }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${DRAFT}" == "true" ]]; then
            draft_label="(draft)"
          else
            draft_label=""
          fi

          # Budujemy tekst bez bawienia sie w reczne JSON-owanie
          content="${EMOJI_ALERT} ${EMOJI_PR} PR opened in \`${REPO}\` ${draft_label}
          ${EMOJI_BRANCH} Branch: \`${HEAD_BRANCH}\` -> \`${BASE_BRANCH}\`
          ${EMOJI_AUTHOR} Author: ${AUTHOR}
          ${EMOJI_LINK} #${PR_NUMBER}: ${PR_TITLE}
          ${PR_URL}"

          # jq robi poprawny JSON (ucieka cudzyslowy itd.)
          payload="$(jq -n --arg content "$content" '{content: $content}')"

          curl -sS -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL"