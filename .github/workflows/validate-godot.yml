name: Validate Godot Project

on:
    pull_request:
        types: [opened, synchronize, closed]

jobs:
    godot-export:
        needs: lint
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Godot
              uses: chickensoft-games/setup-godot@v2
              with:
                  version: 4.6

            - name: Test export to HTML5
              run: |
                  mkdir -p build
                  godot --headless --export-release "HTML5" build/index.html || true
              continue-on-error: true

            - name: Validate project loads
              run: |
                  godot --headless --script scripts/validate_project.gd
              continue-on-error: true

            - name: Run headless tests
              run: |
                  godot --headless --script scripts/run_tests.gd

    godot-scenes:
        needs: lint
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Godot
              uses: chickensoft-games/setup-godot@v2
              with:
                  version: 4.6

            - name: Validate scene dependencies
              run: |
                  python3 << 'EOF'
                  import os
                  import re

                  errors = []

                  for root, dirs, files in os.walk('scenes'):
                      for file in files:
                          if file.endswith('.tscn'):
                              path = os.path.join(root, file)
                              with open(path, 'r') as f:
                                  content = f.read()
                              
                              # Check for broken resource references
                              broken_refs = re.findall(r'\[ext_resource.*path="([^"]+)"', content)
                              for ref in broken_refs:
                                  if not os.path.exists(ref.replace('res://', '')):
                                      errors.append(f"❌ {path}: Missing resource '{ref}'")
                              
                              # Check for invalid UIDs
                              invalid_uids = re.findall(r'uid="(uid://[a-z0-9]+)"', content)
                              for uid in invalid_uids:
                                  if len(uid) < 10:
                                      errors.append(f"⚠️ {path}: Potentially invalid UID '{uid}'")
                              
                              if not errors:
                                  print(f"✓ {path}")

                  if errors:
                      for error in errors:
                          print(error)
                      if any(e.startswith("❌") for e in errors):
                          exit(1)
                  EOF
              continue-on-error: true
